<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>厚安守護中心</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    .card { border-radius: 15px; border: none; }
    .bg-gradient-custom { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  </style>
</head>
<body class="bg-light">

  <div id="loader">
    <div class="spinner-border text-primary"></div>
    <p class="mt-3" id="loader-text">資料比對中...</p>
  </div>

  <div class="container p-4">
    <div id="register-page" style="display:none;">
  <div class="card shadow p-4">
    <h3 class="text-center mb-4">加入守護中心</h3>
    
    <div class="mb-3">
      <label class="form-label">您的姓名</label>
      <input type="text" id="reg-name" class="form-control" placeholder="請輸入姓名">
    </div>
    <div class="mb-3">
      <label class="form-label">您的手機</label>
      <input type="tel" id="reg-phone" class="form-control" placeholder="09xxxxxxxx">
    </div>

    <div class="mb-3">
      <label class="form-label">守護對象是？</label>
      <select id="reg-target" class="form-select" onchange="toggleFields()">
        <option value="self">我自己</option>
        <option value="elder">親友長輩</option>
      </select>
    </div>

    <div id="fields-self">
      <div class="mb-3">
        <label class="form-label">緊急聯絡人姓名</label>
        <input type="text" id="reg-eName" class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">緊急聯絡人電話</label>
        <input type="tel" id="reg-ePhone" class="form-control">
      </div>
    </div>

    <div id="fields-elder" style="display:none;">
      <div class="mb-3">
        <label class="form-label">您如何稱呼受守護者？(如：王奶奶)</label>
        <input type="text" id="reg-uTitle" class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">對象如何稱呼您？(如：乖孫小明)</label>
        <input type="text" id="reg-sAlias" class="form-control">
      </div>
    </div>

    <button onclick="submitRegister()" class="btn btn-primary w-100 py-2 mt-3">完成註冊</button>
  </div>
</div>

    <div id="member-page" style="display:none;">
      <div class="card shadow bg-gradient-custom p-4">
        <p class="small opacity-75">MEMBER CARD</p>
        <h2 id="mem-name" class="mb-3">載入中...</h2>
        <p class="mb-0">電話：<span id="mem-phone">---</span></p>
        <hr>
        <div class="text-end">
          <span class="badge bg-white text-dark">尊榮會員</span>
        </div>
      </div>
      <button class="btn btn-outline-secondary w-100 mt-4">查看歷史紀錄</button>
    </div>
  </div>

  <script>
    const liffId = "2008912295-edmRNdOM"; 
    const gasUrl = "https://script.google.com/macros/s/AKfycbzyedQifRTqM6bnusIsB5XHZfeCaQ22M5D1QoYh3cP92ugT5FrqRqj1EbI74qm4CTuq5w/exec"; 
    let userUid = "";

    async function init() {
      try {
        await liff.init({ liffId: liffId });
        if (!liff.isLoggedIn()) { 
          liff.login(); 
          return;
        }
        const profile = await liff.getProfile();
        userUid = profile.userId;
        checkStatus(userUid);
      } catch (err) {
        showError("LIFF 初始化失敗: " + err);
      }
    }

    function checkStatus(uid) {
      document.getElementById('loader').style.display = 'flex';
      document.getElementById('loader-text').innerText = "資料查詢中...";

      // 增加 action=query 參數以對應新版 GAS
      fetch(`${gasUrl}?action=query&uid=${uid}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('loader').style.display = 'none';
          // 隱藏所有頁面，準備重新顯示
          document.getElementById('register-page').style.display = 'none';
          document.getElementById('member-page').style.display = 'none';

          if (data.exists) {
            document.getElementById('member-page').style.display = 'block';
            document.getElementById('mem-name').innerText = data.name;
            document.getElementById('mem-phone').innerText = data.phone;
          } else {
            document.getElementById('register-page').style.display = 'block';
          }
        })
        .catch(err => showError("讀取資料失敗: " + err.message));
    }

    function submitRegister() {
      const name = document.getElementById('reg-name').value;
      const phone = document.getElementById('reg-phone').value;
      if (!name || !phone) return alert("請完整填寫");

      document.getElementById('loader').style.display = 'flex';
      document.getElementById('loader-text').innerText = "註冊資料寫入中...";

      // 修改處：增加 action=register 參數，並在成功後呼叫 checkStatus
      fetch(`${gasUrl}?action=register&uid=${userUid}&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert("註冊成功！");
            // 關鍵修改：不刷頁面，直接重新查詢狀態，頁面會自動切換至會員卡
            checkStatus(userUid);
          } else {
            throw new Error(data.message || "註冊過程發生錯誤");
          }
        })
        .catch(err => {
          document.getElementById('loader').style.display = 'none';
          alert("註冊失敗: " + err.message);
        });
    }

    function showError(msg) {
      document.getElementById('loader').style.display = 'none';
      alert(msg);
    }

    window.onload = init;
  </script>
</body>
</html>
