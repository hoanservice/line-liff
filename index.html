<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>厚安守護中心</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .card { border-radius: 15px; border: none; }
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: white; display: flex; align-items: center; justify-content: center;
      z-index: 9999; flex-direction: column;
    }
  </style>
</head>
<body>

  <div id="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3 fw-bold">系統安全連線中...</p>
    <p id="debug-info" class="text-muted small"></p>
  </div>
  
  <div id="app-content" class="container p-4" style="display:none;">
    <div class="card shadow p-4 mt-3">
      <h3 class="text-center mb-4 text-primary">厚安守護中心</h3>
      
      <div class="mb-3">
        <label class="form-label fw-bold">會員姓名</label>
        <input type="text" id="userName" class="form-control" placeholder="載入中..." readonly>
      </div>
      
      <div class="mb-3">
        <label class="form-label fw-bold">聯繫電話</label>
        <input type="tel" id="userPhone" class="form-control" placeholder="載入中..." readonly>
      </div>

      <div class="mt-4 pt-3 border-top">
        <p class="text-center text-secondary small">LINE ID: <span id="display-uid">---</span></p>
      </div>
    </div>
  </div>

  <script>
    // --- 請修改下方這兩個變數 ---
    const liffId = "2008912295-edmRNdOM"; 
    const gasUrl = "https://script.google.com/macros/s/AKfycbzyedQifRTqM6bnusIsB5XHZfeCaQ22M5D1QoYh3cP92ugT5FrqRqj1EbI74qm4CTuq5w/exec"; 
    // -----------------------

    function updateDebug(msg) {
      console.log(msg);
      document.getElementById('debug-info').innerText = msg;
    }

    async function startApp() {
      updateDebug("正在啟動 LIFF...");
      try {
        await liff.init({ liffId: liffId });
        
        if (!liff.isLoggedIn()) {
          updateDebug("引導登入中...");
          liff.login();
        } else {
          const profile = await liff.getProfile();
          document.getElementById('display-uid').innerText = profile.userId;
          fetchDataFromGAS(profile.userId);
        }
      } catch (err) {
        updateDebug("LIFF 錯誤: " + err.message);
        alert("系統初始化失敗，請稍後再試。");
      }
    }

    async function fetchDataFromGAS(uid) {
      updateDebug("正在同步會員資料...");
      
      // 使用 fetch 呼叫 GAS 的 doGet
      const finalUrl = `${gasUrl}?uid=${uid}`;

      try {
        const response = await fetch(finalUrl, {
          method: 'GET',
          mode: 'cors' // 這是解決 Load failed 的關鍵
        });

        if (!response.ok) throw new Error("網路請求失敗");
        
        const data = await response.json();
        updateDebug("資料解析成功");

        // 隱藏讀取，顯示內容
        document.getElementById('loading-overlay').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';

        // 填入資料 (請確認您的 GAS 回傳的 JSON 欄位名稱是否為 name 和 phone)
        if (data.name) {
          document.getElementById('userName').value = data.name;
          document.getElementById('userPhone').value = data.phone;
        } else {
          document.getElementById('userName').value = "新會員";
          document.getElementById('userPhone').value = "請先完成註冊";
        }

      } catch (err) {
        updateDebug("資料讀取失敗: " + err.message);
        alert("讀取資料失敗，請確認網路連線是否正常。");
      }
    }

    window.onload = startApp;
  </script>
</body>
</html>
