<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åšå®‰å®ˆè­·ä¸­å¿ƒ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    .card { border-radius: 15px; border: none; }
    .bg-gradient-custom { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .bg-gradient-target { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: white; }
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  </style>
</head>
<body class="bg-light">

  <div id="loader">
    <div class="spinner-border text-primary"></div>
    <p class="mt-3" id="loader-text">è³‡æ–™æ¯”å°ä¸­...</p>
  </div>

  <div class="container p-4">
    <div id="register-page" style="display:none;">
      <div class="card shadow p-4">
        <h3 class="text-center mb-4">åŠ å…¥åšå®‰å®ˆè­·ä¸­å¿ƒ</h3>
        <div class="mb-3">
          <label class="form-label">æ‚¨çš„å§“å</label>
          <input type="text" id="reg-name" class="form-control" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
        </div>
        <div class="mb-3">
          <label class="form-label">æ‚¨çš„æ‰‹æ©Ÿ</label>
          <input type="tel" id="reg-phone" class="form-control" placeholder="09xxxxxxxx">
        </div>
        <div class="mb-3">
          <label class="form-label">æ‚¨è¦å®ˆè­·çš„å°è±¡æ˜¯ï¼Ÿ</label>
          <select id="reg-target" class="form-select" onchange="toggleFields()">
            <option value="self">è‡ªå·±</option>
            <option value="elder">è¦ªå‹</option>
          </select>
        </div>
        <div id="fields-self">
          <div class="mb-3">
            <label class="form-label">ç·Šæ€¥è¯çµ¡äººå§“å</label>
            <input type="text" id="reg-eName" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">ç·Šæ€¥è¯çµ¡äººé›»è©±</label>
            <input type="tel" id="reg-ePhone" class="form-control">
          </div>
        </div>
        <div id="fields-elder" style="display:none;">
          <div class="mb-3">
            <label class="form-label">æ‚¨å¦‚ä½•ç¨±å‘¼å®ˆè­·å°è±¡ï¼Ÿ(å¦‚ï¼šçˆºçˆº)</label>
            <input type="text" id="reg-uTitle" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">å°æ–¹å¦‚ä½•ç¨±å‘¼æ‚¨ï¼Ÿ(å¦‚ï¼šä¹–å­«å°æ˜)</label>
            <input type="text" id="reg-sAlias" class="form-control">
          </div>
        </div>
        <button onclick="submitRegister()" class="btn btn-primary w-100 py-2 mt-3">å®Œæˆè¨»å†Š</button>
      </div>
    </div>

    <div id="member-page" style="display:none;">
      <div id="member-card" class="card shadow bg-gradient-custom p-4">
        <p id="card-type-label" class="small opacity-75 mb-2">MEMBER CARD</p>
        <h2 id="mem-name" class="mb-1">è¼‰å…¥ä¸­...</h2>
        <p id="mem-phone" class="mb-3">---</p>
        
        <div id="guardian-info-box" style="display:none; background: rgba(255,255,255,0.2); border-radius: 10px; padding: 10px; margin-top: 10px;">
          <p class="mb-0 small">âœ¨ å—å®ˆè­·ä¸­</p>
          <h5 class="mb-0">å®ˆè­·è€…ï¼š<span id="guardian-name">---</span></h5>
          <p class="small mb-0" id="guardian-relation-text"></p>
        </div>

        <div id="emergency-info" style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px; display:none;">
          <p class="small mb-1" style="opacity: 0.8;">ç·Šæ€¥è¯çµ¡è³‡è¨Š</p>
          <p class="mb-0">å§“åï¼š<span id="mem-eName">---</span></p>
          <p class="mb-0">é›»è©±ï¼š<span id="mem-ePhone">---</span></p>
        </div>

        <div id="elder-info" style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px; display:none;">
          <p class="small mb-1" style="opacity: 0.8;">å®ˆè­·è³‡è¨Š</p>
          <p class="mb-0">å°è±¡ï¼š<span id="mem-uTitle">---</span></p>
          <p class="mb-0">è‡ªç¨±ï¼š<span id="mem-sAlias">---</span></p>
        </div>

        <div class="text-end mt-3">
          <span class="badge bg-white text-dark">ä¸€èˆ¬æœƒå“¡</span>
        </div>
      </div>
      
      <p class="text-center mt-3 small text-secondary">â€» å¦‚éœ€ä¿®æ”¹æœƒå“¡è³‡æ–™ï¼Œè«‹èˆ‡å®¢æœè¯ç¹«ã€‚</p>

      <div id="manager-actions" class="mt-4" style="display:none;">
        <button onclick="sendInvite()" class="btn btn-success w-100 py-2">å‚³é€å®ˆè­·å¡çµ¦æŒ‡å®šå°è±¡</button>
        <p class="text-center small text-secondary mt-2">é»æ“Šå‚³é€é€£çµï¼Œè®“å®ˆè­·å°è±¡ç¶å®šæ‚¨çš„å¸³è™Ÿ</p>
      </div>

      <div id="target-notice" class="alert alert-info mt-4" style="display:none;">
        æ‚¨çš„å¸³è™Ÿå·²å—å®ˆè­·ï¼Œå¦‚æœ‰éœ€æ±‚è«‹é»æ“Šä¸‹æ–¹å›å ±ã€‚
      </div>
      <div class="mt-4">
  <h6 class="text-secondary fw-bold">è¿‘ 7 å¤©å›å ±ç´€éŒ„</h6>
  <div id="history-list" class="list-group shadow-sm">
    <div class="list-group-item small text-center text-muted">è®€å–ä¸­...</div>
  </div>
</div>
    </div>
  </div>

  <script>
    const liffId = "2008912295-edmRNdOM"; 
    const gasUrl = "https://script.google.com/macros/s/AKfycbzyedQifRTqM6bnusIsB5XHZfeCaQ22M5D1QoYh3cP92ugT5FrqRqj1EbI74qm4CTuq5w/exec"; 
    let userUid = "";
    let inviterId = "";

    async function init() {
      try {
        await liff.init({ liffId: liffId });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        
        const profile = await liff.getProfile();
        userUid = profile.userId;

        const urlParams = new URLSearchParams(window.location.search);
        inviterId = urlParams.get('inviter');

        checkStatus(userUid);
      } catch (err) {
        showError("LIFF åˆå§‹åŒ–å¤±æ•—: " + err);
      }
    }

    function checkStatus(uid) {
      document.getElementById('loader').style.display = 'flex';
      fetch(`${gasUrl}?action=query&uid=${uid}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('loader').style.display = 'none';
          document.getElementById('register-page').style.display = 'none';
          document.getElementById('member-page').style.display = 'none';

          if (data.exists) {
            document.getElementById('member-page').style.display = 'block';
            document.getElementById('mem-name').innerText = data.name;
            document.getElementById('mem-phone').innerText = "é›»è©±ï¼š" + data.phone;

            const card = document.getElementById('member-card');
            
            // --- åˆ¤æ–·è§’è‰²é¡¯ç¤ºé‚è¼¯ ---
            if (data.isTarget) {
              card.className = "card shadow bg-gradient-target p-4";
              document.getElementById('card-type-label').innerText = "GUARDIAN CARD";
              document.getElementById('guardian-info-box').style.display = 'block';
              document.getElementById('guardian-name').innerText = data.guardianName;
              document.getElementById('guardian-relation-text').innerText = `${data.sAlias || 'è¦ªå‹'} æ­£åœ¨å®ˆè­·æ‚¨`;
              document.getElementById('target-notice').style.display = 'block';
              document.getElementById('manager-actions').style.display = 'none';
              document.getElementById('emergency-info').style.display = 'none';
              document.getElementById('elder-info').style.display = 'none';
            } else {
              card.className = "card shadow bg-gradient-custom p-4";
              document.getElementById('card-type-label').innerText = "MEMBER CARD";
              document.getElementById('guardian-info-box').style.display = 'none';
              document.getElementById('target-notice').style.display = 'none';
              
              if (data.target === 'self') {
                document.getElementById('emergency-info').style.display = 'block';
                document.getElementById('elder-info').style.display = 'none';
                document.getElementById('mem-eName').innerText = data.eName || "æœªå¡«å¯«";
                document.getElementById('mem-ePhone').innerText = data.ePhone || "æœªå¡«å¯«";
                document.getElementById('manager-actions').style.display = 'none';
              } else {
                document.getElementById('emergency-info').style.display = 'none';
                document.getElementById('elder-info').style.display = 'block';
                document.getElementById('mem-uTitle').innerText = data.uTitle || "æœªå¡«å¯«";
                document.getElementById('mem-sAlias').innerText = data.sAlias || "æœªå¡«å¯«";
                
                if (data.hasManaged) {
                  document.getElementById('manager-actions').innerHTML = `<button class="btn btn-info w-100 text-white py-2">æŸ¥çœ‹å—å®ˆè­·è€…ç‹€æ…‹</button>`;
                }
                document.getElementById('manager-actions').style.display = 'block';
              }
            }

            // ==========================================
            // é€™è£¡å°±æ˜¯ä½ è¦æ”¾ã€Œé¡¯ç¤ºç´€éŒ„ã€çš„åœ°æ–¹ï¼
            // ==========================================
            const historyBox = document.getElementById('history-list');
            if (data.history && data.history.length > 0) {
              historyBox.innerHTML = data.history.map(item => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <span>${item.name} å ±å¹³å®‰</span>
                  <span class="badge bg-light text-secondary">${item.time}</span>
                </div>
              `).join('');
            } else {
              historyBox.innerHTML = '<div class="list-group-item small text-center text-muted">ç›®å‰å°šç„¡ç´€éŒ„</div>';
            }
            // ==========================================

          } else {
            document.getElementById('register-page').style.display = 'block';
          }
        })
        .catch(err => showError("è®€å–å¤±æ•—: " + err.message));
    }

    function toggleFields() {
      const target = document.getElementById('reg-target').value;
      document.getElementById('fields-self').style.display = (target === 'self') ? 'block' : 'none';
      document.getElementById('fields-elder').style.display = (target === 'elder') ? 'block' : 'none';
    }

    function submitRegister() {
      const name = document.getElementById('reg-name').value;
      const phone = document.getElementById('reg-phone').value;
      const target = document.getElementById('reg-target').value;
      if (!name || !phone) return alert("è«‹å®Œæ•´å¡«å¯«åŸºæœ¬è³‡æ–™");

      let params = `action=register&uid=${userUid}&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}&target=${target}`;
      if (inviterId) params += `&inviter=${inviterId}`;

      if (target === 'self') {
        params += `&eName=${encodeURIComponent(document.getElementById('reg-eName').value)}&ePhone=${encodeURIComponent(document.getElementById('reg-ePhone').value)}`;
      } else {
        params += `&uTitle=${encodeURIComponent(document.getElementById('reg-uTitle').value)}&sAlias=${encodeURIComponent(document.getElementById('reg-sAlias').value)}`;
      }

      document.getElementById('loader').style.display = 'flex';
      fetch(`${gasUrl}?${params}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert("è¨»å†ŠæˆåŠŸï¼");
            location.href = window.location.pathname; // æ¸…é™¤ç¶²å€åƒæ•¸ä¸¦é‡æ•´
          }
        })
        .catch(err => showError("è¨»å†Šå¤±æ•—: " + err));
    }

    function sendInvite() {
  if (!liff.isApiAvailable('shareTargetPicker')) return alert("è«‹åœ¨ LINE App ä¸­é–‹å•Ÿ");
  
  // å–å¾—ç•¶å‰ç”¨æˆ¶ï¼ˆå®ˆè­·è€…ï¼‰çš„å§“åï¼Œè®“è¨Šæ¯æ›´æœ‰æº«åº¦
  const senderName = document.getElementById('mem-name').innerText;
  const inviteUrl = `https://liff.line.me/${liffId}?inviter=${userUid}`;

  liff.shareTargetPicker([{
    "type": "flex",
    "altText": `${senderName} é‚€è«‹æ‚¨åŠ å…¥åšå®‰å®ˆè­·`,
    "contents": {
      "type": "bubble",
      "styles": {
        "footer": { "separator": true }
      },
      "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "åšå®‰å®ˆè­·ä¸­å¿ƒ ğŸ›¡ï¸",
            "weight": "bold",
            "color": "#4A90E2",
            "size": "sm"
          },
          {
            "type": "text",
            "text": "æˆç‚ºå®¶äººçš„æº«æš–ä¾é ",
            "weight": "bold",
            "size": "xl",
            "margin": "md",
            "color": "#333333"
          },
          {
            "type": "text",
            "text": `è¦ªæ„›çš„å®¶äººï¼Œæˆ‘æ˜¯ ${senderName}ã€‚æˆ‘å·²ç‚ºæ‚¨ç”³è«‹äº†ã€Œåšå®‰å®ˆè­·å¡ã€ã€‚`,
            "size": "sm",
            "color": "#555555",
            "wrap": true,
            "margin": "lg"
          },
          {
            "type": "text",
            "text": "é‚€è«‹æ‚¨é»æ“Šä¸‹æ–¹æŒ‰éˆ•å®Œæˆç¶å®šï¼Œè®“é€™ä»½å®ˆè­·åœ¨æ—¥å¸¸ä¸­å¤šä¸€ä»½å®‰å¿ƒã€‚",
            "size": "sm",
            "color": "#555555",
            "wrap": true,
            "margin": "sm"
          },
          {
            "type": "button",
            "style": "primary",
            "color": "#667eea",
            "margin": "xxl",
            "height": "sm",
            "action": {
              "type": "uri",
              "label": "âœ¨ æ¥å—å®ˆè­·ä¸¦ç¶å®š âœ¨",
              "uri": inviteUrl
            }
          }
        ]
      },
      "footer": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "æ­¤é€£çµåƒ…é™æœ¬äººç¶å®šä½¿ç”¨",
            "size": "xxs",
            "color": "#aaaaaa",
            "align": "center"
          }
        ]
      }
    }
  }])
  .then(res => { if (res) { alert("å®ˆè­·é‚€è«‹å·²é€å‡ºï¼"); } })
  .catch(err => console.error("å‚³é€å¤±æ•—", err));
}

    function showError(msg) {
      document.getElementById('loader').style.display = 'none';
      alert(msg);
    }

    window.onload = init;
  </script>
</body>
</html>
