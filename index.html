<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>厚安守護中心</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    .card { border-radius: 15px; border: none; }
    .bg-gradient-custom { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .bg-gradient-target { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: white; }
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  </style>
</head>
<body class="bg-light">

  <div id="loader">
    <div class="spinner-border text-primary"></div>
    <p class="mt-3" id="loader-text">資料比對中...</p>
  </div>

  <div class="container p-4">
    <div id="register-page" style="display:none;">
      <div class="card shadow p-4">
        <h3 class="text-center mb-4">加入厚安守護中心</h3>
        <div class="mb-3">
          <label class="form-label">您的姓名</label>
          <input type="text" id="reg-name" class="form-control" placeholder="請輸入真實姓名">
        </div>
        <div class="mb-3">
          <label class="form-label">您的手機</label>
          <input type="tel" id="reg-phone" class="form-control" placeholder="09xxxxxxxx">
        </div>
        <div class="mb-3">
          <label class="form-label">您要守護的對象是？</label>
          <select id="reg-target" class="form-select" onchange="toggleFields()">
            <option value="self">自己</option>
            <option value="elder">親友</option>
          </select>
        </div>
        <div id="fields-self">
          <div class="mb-3">
            <label class="form-label">緊急聯絡人姓名</label>
            <input type="text" id="reg-eName" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">緊急聯絡人電話</label>
            <input type="tel" id="reg-ePhone" class="form-control">
          </div>
        </div>
        <div id="fields-elder" style="display:none;">
          <div class="mb-3">
            <label class="form-label">您如何稱呼守護對象？(如：爺爺)</label>
            <input type="text" id="reg-uTitle" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">對方如何稱呼您？(如：乖孫小明)</label>
            <input type="text" id="reg-sAlias" class="form-control">
          </div>
        </div>
        <button onclick="submitRegister()" class="btn btn-primary w-100 py-2 mt-3">完成註冊</button>
      </div>
    </div>

    <div id="member-page" style="display:none;">
      <div id="member-card" class="card shadow bg-gradient-custom p-4">
        <p id="card-type-label" class="small opacity-75 mb-2">MEMBER CARD</p>
        <h2 id="mem-name" class="mb-1">載入中...</h2>
        <p id="mem-phone" class="mb-3">---</p>
        
        <div id="guardian-info-box" style="display:none; background: rgba(255,255,255,0.2); border-radius: 10px; padding: 10px; margin-top: 10px;">
          <p class="mb-0 small">✨ 受守護中</p>
          <h5 class="mb-0">守護者：<span id="guardian-name">---</span></h5>
          <p class="small mb-0" id="guardian-relation-text"></p>
        </div>

        <div id="emergency-info" style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px; display:none;">
          <p class="small mb-1" style="opacity: 0.8;">緊急聯絡資訊</p>
          <p class="mb-0">姓名：<span id="mem-eName">---</span></p>
          <p class="mb-0">電話：<span id="mem-ePhone">---</span></p>
        </div>

        <div id="elder-info" style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px; display:none;">
          <p class="small mb-1" style="opacity: 0.8;">守護資訊</p>
          <p class="mb-0">對象：<span id="mem-uTitle">---</span></p>
          <p class="mb-0">自稱：<span id="mem-sAlias">---</span></p>
        </div>

        <div class="text-end mt-3">
          <span class="badge bg-white text-dark">一般會員</span>
        </div>
      </div>
      
      <p class="text-center mt-3 small text-secondary">※ 如需修改會員資料，請與客服聯繫。</p>

      <div id="manager-actions" class="mt-4" style="display:none;">
        <button onclick="sendInvite()" class="btn btn-success w-100 py-2">傳送守護卡給指定對象</button>
        <p class="text-center small text-secondary mt-2">點擊傳送連結，讓守護對象綁定您的帳號</p>
      </div>

      <div id="target-notice" class="alert alert-info mt-4" style="display:none;">
        您的帳號已受守護，如有需求請點擊下方回報。
      </div>
      <div class="mt-4">
  <h6 class="text-secondary fw-bold">近 7 天回報紀錄</h6>
  <div id="history-list" class="list-group shadow-sm">
    <div class="list-group-item small text-center text-muted">讀取中...</div>
  </div>
</div>
    </div>
  </div>

  <script>
    const liffId = "2008912295-edmRNdOM"; 
    const gasUrl = "https://script.google.com/macros/s/AKfycbyBkgvbHViTf0oWj3K_TZvy7VPwZUQ3UAfvFQPt8U7FxCI1DMi-QIbEy3Epmol_8mWG/exec"; 
    let userUid = "";
    let inviterId = "";

    async function init() {
      try {
        await liff.init({ liffId: liffId });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        
        const profile = await liff.getProfile();
        userUid = profile.userId;

        const urlParams = new URLSearchParams(window.location.search);
        inviterId = urlParams.get('inviter');

        checkStatus(userUid);
      } catch (err) {
        showError("LIFF 初始化失敗: " + err);
      }
    }

    function checkStatus(uid) {
      document.getElementById('loader').style.display = 'flex';
      fetch(`${gasUrl}?action=query&uid=${uid}`, {
      method: 'GET',
      mode: 'cors'
      })
        .then(res => res.json())
        .then(data => {
          document.getElementById('loader').style.display = 'none';
          document.getElementById('register-page').style.display = 'none';
          document.getElementById('member-page').style.display = 'none';

          if (data.exists) {
            document.getElementById('member-page').style.display = 'block';
            document.getElementById('mem-name').innerText = data.name;
            document.getElementById('mem-phone').innerText = "電話：" + data.phone;

            const card = document.getElementById('member-card');
            
            // --- 判斷角色顯示邏輯 ---
            if (data.isTarget) {
              card.className = "card shadow bg-gradient-target p-4";
              document.getElementById('card-type-label').innerText = "GUARDIAN CARD";
              document.getElementById('guardian-info-box').style.display = 'block';
              document.getElementById('guardian-name').innerText = data.guardianName;
              document.getElementById('guardian-relation-text').innerText = `${data.sAlias || '親友'} 正在守護您`;
              document.getElementById('target-notice').style.display = 'block';
              document.getElementById('manager-actions').style.display = 'none';
              document.getElementById('emergency-info').style.display = 'none';
              document.getElementById('elder-info').style.display = 'none';
            } else {
              card.className = "card shadow bg-gradient-custom p-4";
              document.getElementById('card-type-label').innerText = "MEMBER CARD";
              document.getElementById('guardian-info-box').style.display = 'none';
              document.getElementById('target-notice').style.display = 'none';
              
              if (data.target === 'self') {
                document.getElementById('emergency-info').style.display = 'block';
                document.getElementById('elder-info').style.display = 'none';
                document.getElementById('mem-eName').innerText = data.eName || "未填寫";
                document.getElementById('mem-ePhone').innerText = data.ePhone || "未填寫";
                document.getElementById('manager-actions').style.display = 'none';
              } else {
                document.getElementById('emergency-info').style.display = 'none';
                document.getElementById('elder-info').style.display = 'block';
                document.getElementById('mem-uTitle').innerText = data.uTitle || "未填寫";
                document.getElementById('mem-sAlias').innerText = data.sAlias || "未填寫";
                
                if (data.hasManaged) {
                  document.getElementById('manager-actions').innerHTML = `<button class="btn btn-info w-100 text-white py-2">查看受守護者狀態</button>`;
                }
                document.getElementById('manager-actions').style.display = 'block';
              }
            }

            // ==========================================
            // 這裡就是你要放「顯示紀錄」的地方！
            // ==========================================
            const historyBox = document.getElementById('history-list');
            if (data.history && data.history.length > 0) {
              historyBox.innerHTML = data.history.map(item => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <span>${item.name} 報平安</span>
                  <span class="badge bg-light text-secondary">${item.time}</span>
                </div>
              `).join('');
            } else {
              historyBox.innerHTML = '<div class="list-group-item small text-center text-muted">目前尚無紀錄</div>';
            }
            // ==========================================

          } else {
            document.getElementById('register-page').style.display = 'block';
          }
        })
        .catch(err => showError("讀取失敗: " + err.message));
    }

    function toggleFields() {
      const target = document.getElementById('reg-target').value;
      document.getElementById('fields-self').style.display = (target === 'self') ? 'block' : 'none';
      document.getElementById('fields-elder').style.display = (target === 'elder') ? 'block' : 'none';
    }

    function submitRegister() {
      const name = document.getElementById('reg-name').value;
      const phone = document.getElementById('reg-phone').value;
      const target = document.getElementById('reg-target').value;
      if (!name || !phone) return alert("請完整填寫基本資料");

      let params = `action=register&uid=${userUid}&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}&target=${target}`;
      if (inviterId) params += `&inviter=${inviterId}`;

      if (target === 'self') {
        params += `&eName=${encodeURIComponent(document.getElementById('reg-eName').value)}&ePhone=${encodeURIComponent(document.getElementById('reg-ePhone').value)}`;
      } else {
        params += `&uTitle=${encodeURIComponent(document.getElementById('reg-uTitle').value)}&sAlias=${encodeURIComponent(document.getElementById('reg-sAlias').value)}`;
      }

      document.getElementById('loader').style.display = 'flex';
      fetch(`${gasUrl}?${params}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert("註冊成功！");
            location.href = window.location.pathname; // 清除網址參數並重整
          }
        })
        .catch(err => showError("註冊失敗: " + err));
    }

function sendInvite() {
      if (!liff.isApiAvailable('shareTargetPicker')) return alert("請在 LINE App 中開啟");
      
      // 1. 取得發送者姓名
      const senderName = document.getElementById('mem-name').innerText;

      // 2. 取得稱謂 (從網頁上的隱藏欄位抓取)
      let targetTitle = document.getElementById('mem-uTitle').innerText;
      
      // 防呆：如果網頁還沒載入完，或是顯示預設值，就用「家人」代替
      if (!targetTitle || targetTitle === "---" || targetTitle === "未填寫") {
        targetTitle = "家人";
      }

      const inviteUrl = `https://liff.line.me/${liffId}?inviter=${userUid}`;

      liff.shareTargetPicker([{
      "type": "flex",
      "altText": `${senderName} 邀請您加入厚安守護`,
      "contents": {
      "type": "bubble",
      "styles": {
        "footer": { "separator": true }
      },
      "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "厚安守護寶",
            "weight": "bold",
            "color": "#4A90E2",
            "size": "sm"
          },
          {
            "type": "text",
            "text": "成為您與家人安心的依靠",
            "weight": "bold",
            "size": "xl",
            "margin": "md",
            "color": "#333333"
          },
          {
            "type": "text",
            "text": `親愛的${targetTitle}，我是 ${senderName}。我已為您申請「厚安守護」，邀請您每天打卡報平安。`,
            "size": "sm",
            "color": "#555555",
            "wrap": true,
            "margin": "lg"
          },
          {
            "type": "text",
            "text": "請您點擊下方按鈕完成綁定，讓我們每天日常多一份安心與溫暖。",
            "size": "sm",
            "color": "#555555",
            "wrap": true,
            "margin": "sm"
          },
          {
            "type": "button",
            "style": "primary",
            "color": "#667eea",
            "margin": "xxl",
            "height": "sm",
            "action": {
              "type": "uri",
              "label": "✨ 接受守護並綁定 ✨",
              "uri": inviteUrl
            }
          }
        ]
      },
      "footer": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "此連結僅限本人綁定使用，請勿轉傳",
            "size": "xxs",
            "color": "#aaaaaa",
            "align": "center"
          }
        ]
      }
    }
  }])
  .then(res => { if (res) { alert("守護邀請已送出！"); } })
  .catch(err => console.error("傳送失敗", err));
}

    function showError(msg) {
      document.getElementById('loader').style.display = 'none';
      alert(msg);
    }

    window.onload = init;
  </script>
</body>
</html>
