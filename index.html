<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åšå®‰å®ˆè­·ä¸­å¿ƒ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    .card { border-radius: 15px; border: none; }
    /* æœƒå“¡å¡æ¼¸å±¤èƒŒæ™¯ */
    .bg-gradient-custom { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    /* å®ˆè­·è€…å¡æ¼¸å±¤èƒŒæ™¯ */
    .bg-gradient-target { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: white; }
    
    /* è®€å–å‹•ç•«é®ç½© */
    #loader { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(255,255,255,0.9); z-index: 9999; 
      display: flex; flex-direction: column; justify-content: center; align-items: center; 
    }
  </style>
</head>
<body class="bg-light">

  <div id="loader">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <p class="mt-3 text-secondary fw-bold" id="loader-text">ç³»çµ±é€£ç·šä¸­...</p>
  </div>

  <div class="container p-4" style="max-width: 600px;">
    
    <div id="register-page" style="display:none;">
      <div class="card shadow p-4">
        <h3 class="text-center mb-4 fw-bold text-primary">åŠ å…¥åšå®‰å®ˆè­·ä¸­å¿ƒ</h3>
        <p class="text-muted text-center small mb-4">ç°¡å–®å¹¾æ­¥ï¼Œè®“å®¶äººæ›´å®‰å¿ƒ</p>
        
        <div class="mb-3">
          <label class="form-label fw-bold">æ‚¨çš„å§“å</label>
          <input type="text" id="reg-name" class="form-control form-control-lg" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
        </div>
        
        <div class="mb-3">
          <label class="form-label fw-bold">æ‚¨çš„æ‰‹æ©Ÿ</label>
          <input type="tel" id="reg-phone" class="form-control form-control-lg" placeholder="09xxxxxxxx (å…±10ç¢¼)">
        </div>
        
        <div class="mb-3">
          <label class="form-label fw-bold">æ‚¨è¦å®ˆè­·çš„å°è±¡æ˜¯ï¼Ÿ</label>
          <select id="reg-target" class="form-select form-select-lg" onchange="toggleFields()">
            <option value="self">è‡ªå·± (ç¨å±…/è‡ªä½)</option>
            <option value="elder">è¦ªå‹ (é•·è¼©/å­å¥³)</option>
          </select>
        </div>
        
        <div id="fields-self" class="bg-light p-3 rounded mb-3 border">
          <div class="alert alert-warning border-0 small py-2">
            <i class="bi bi-exclamation-circle-fill"></i> ç‚ºç¢ºä¿å®‰å…¨ï¼Œè«‹å‹™å¿…å¡«å¯«ä¸€ä½ç·Šæ€¥è¯çµ¡äººã€‚
          </div>
          <div class="mb-3">
            <label class="form-label">ç·Šæ€¥è¯çµ¡äººå§“å</label>
            <input type="text" id="reg-eName" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">ç·Šæ€¥è¯çµ¡äººé›»è©±</label>
            <input type="tel" id="reg-ePhone" class="form-control" placeholder="09xxxxxxxx">
          </div>
        </div>

        <div id="fields-elder" style="display:none;" class="bg-light p-3 rounded mb-3 border">
          <div class="mb-3">
            <label class="form-label">æ‚¨å¦‚ä½•ç¨±å‘¼å®ˆè­·å°è±¡ï¼Ÿ</label>
            <input type="text" id="reg-uTitle" class="form-control" placeholder="ä¾‹ï¼šçˆºçˆºã€å¥¶å¥¶ã€çˆ¸çˆ¸">
            <div class="form-text">é€™å°‡é¡¯ç¤ºåœ¨çµ¦å°æ–¹çš„é‚€è«‹å‡½ä¸­</div>
          </div>
          <div class="mb-3">
            <label class="form-label">å°æ–¹å¦‚ä½•ç¨±å‘¼æ‚¨ï¼Ÿ</label>
            <input type="text" id="reg-sAlias" class="form-control" placeholder="ä¾‹ï¼šä¹–å­«å°æ˜">
          </div>
        </div>

        <button onclick="submitRegister()" class="btn btn-primary w-100 py-3 mt-2 fw-bold shadow-sm">å®Œæˆè¨»å†Š</button>
      </div>
    </div>

    <div id="member-page" style="display:none;">
      <div id="member-card" class="card shadow bg-gradient-custom p-4 text-white">
        <div class="d-flex justify-content-between align-items-start">
            <h2 id="mem-name" class="mb-1 fw-bold">è¼‰å…¥ä¸­...</h2>
            <span class="badge bg-white text-dark opacity-75">ä¸€èˆ¬æœƒå“¡</span>
        </div>
        <p id="mem-phone" class="mb-3 opacity-75">---</p>
        
        <div id="guardian-info-box" style="display:none; background: rgba(255,255,255,0.2); border-radius: 10px; padding: 12px; margin-top: 10px;">
          <p class="mb-0 small opacity-75">âœ¨ ç›®å‰ç‹€æ…‹ï¼šå—å®ˆè­·ä¸­</p>
          <h5 class="mb-1 mt-1">å®ˆè­·è€…ï¼š<span id="guardian-name">---</span></h5>
          <p class="small mb-0" id="guardian-relation-text"></p>
        </div>

        <div id="emergency-info" style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px; margin-top: 15px; display:none;">
          <p class="small mb-1 opacity-75">ç·Šæ€¥è¯çµ¡è³‡è¨Š</p>
          <p class="mb-0">å§“åï¼š<span id="mem-eName">---</span></p>
          <p class="mb-0">é›»è©±ï¼š<span id="mem-ePhone">---</span></p>
        </div>

        <div id="elder-info" style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px; margin-top: 15px; display:none;">
          <p class="small mb-1 opacity-75">å®ˆè­·è³‡è¨Š</p>
          <p class="mb-0">å®ˆè­·å°è±¡ï¼š<span id="mem-uTitle">---</span></p>
          <p class="mb-0">æ‚¨çš„è‡ªç¨±ï¼š<span id="mem-sAlias">---</span></p>
        </div>
      </div>
      
      <div id="manager-actions" class="mt-4" style="display:none;">
        <button onclick="sendInvite()" class="btn btn-success w-100 py-3 shadow-sm fw-bold">
            <i class="bi bi-send-fill"></i> å‚³é€å®ˆè­·å¡çµ¦æŒ‡å®šå°è±¡
        </button>
        <p class="text-center small text-secondary mt-2">é»æ“Šä¸Šæ–¹æŒ‰éˆ•ï¼Œå‚³é€ LINE è¨Šæ¯é‚€è«‹å®¶äººç¶å®š</p>
      </div>

      <div id="target-notice" class="alert alert-info mt-4 text-center shadow-sm border-0" style="display:none;">
        ğŸ›¡ï¸ æ‚¨çš„å¸³è™Ÿå·²å—å®ˆè­·<br>å¦‚æœ‰éœ€æ±‚è«‹é»æ“Š LINE é¸å–®å›å ±
      </div>
      
      <div class="mt-4">
        <h6 class="text-secondary fw-bold px-1">ğŸ“… è¿‘ 7 å¤©å›å ±ç´€éŒ„</h6>
        <div id="history-list" class="list-group shadow-sm border-0">
          <div class="list-group-item small text-center text-muted py-3">è®€å–ä¸­...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // â˜…â˜…â˜… è¨­å®šå€ â˜…â˜…â˜…
    const liffId = "2008912295-edmRNdOM"; 
    // è«‹ç¢ºèªé€™æ˜¯ä¸æ˜¯æ‚¨æœ€æ–°çš„ GAS ç¶²å€ (å¦‚æœä¸å°è«‹è‡ªè¡Œæ›¿æ›)
    const gasUrl = "https://script.google.com/macros/s/AKfycbyBkgvbHViTf0oWj3K_TZvy7VPwZUQ3UAfvFQPt8U7FxCI1DMi-QIbEy3Epmol_8mWG/exec"; 
    
    let userUid = "";
    let inviterId = "";

    // 1. åˆå§‹åŒ– LIFF
    async function init() {
      try {
        await liff.init({ liffId: liffId });
        if (!liff.isLoggedIn()) { 
            liff.login(); 
            return; 
        }
        
        const profile = await liff.getProfile();
        userUid = profile.userId;

        // å–å¾— URL åƒæ•¸ (æª¢æŸ¥æ˜¯å¦æœ‰é‚€è«‹è€…)
        const urlParams = new URLSearchParams(window.location.search);
        inviterId = urlParams.get('inviter');

        checkStatus(userUid);
      } catch (err) {
        showError("LIFF åˆå§‹åŒ–å¤±æ•—: " + err);
      }
    }

    // 2. æª¢æŸ¥æœƒå“¡ç‹€æ…‹
    function checkStatus(uid) {
      document.getElementById('loader').style.display = 'flex';
      
      fetch(`${gasUrl}?action=query&uid=${uid}`, { method: 'GET', mode: 'cors' })
        .then(res => res.json())
        .then(data => {
          document.getElementById('loader').style.display = 'none';
          document.getElementById('register-page').style.display = 'none';
          document.getElementById('member-page').style.display = 'none';

          if (data.exists) {
            // === é¡¯ç¤ºæœƒå“¡é é¢ ===
            document.getElementById('member-page').style.display = 'block';
            document.getElementById('mem-name').innerText = data.name;
            document.getElementById('mem-phone').innerText = data.phone;

            const card = document.getElementById('member-card');
            
            // A. å¦‚æœæˆ‘æ˜¯ã€Œå—å®ˆè­·è€…ã€ (è¢«å®ˆè­·æ¨¡å¼)
            if (data.isTarget) {
              card.className = "card shadow bg-gradient-target p-4 text-white";
              document.getElementById('guardian-info-box').style.display = 'block';
              document.getElementById('guardian-name').innerText = data.guardianName;
              document.getElementById('guardian-relation-text').innerText = `${data.sAlias || 'è¦ªå‹'} æ­£åœ¨å®ˆè­·æ‚¨`;
              
              document.getElementById('target-notice').style.display = 'block';
              document.getElementById('manager-actions').style.display = 'none';
              document.getElementById('emergency-info').style.display = 'none';
              document.getElementById('elder-info').style.display = 'none';
            } 
            // B. å¦‚æœæˆ‘æ˜¯ã€Œå®ˆè­·è€…ã€æˆ–ã€Œè‡ªç«‹è‡ªå¼·ã€ (ä¸€èˆ¬æ¨¡å¼)
            else {
              card.className = "card shadow bg-gradient-custom p-4 text-white";
              document.getElementById('guardian-info-box').style.display = 'none';
              document.getElementById('target-notice').style.display = 'none';
              
              if (data.target === 'self') {
                document.getElementById('emergency-info').style.display = 'block';
                document.getElementById('elder-info').style.display = 'none';
                document.getElementById('mem-eName').innerText = data.eName || "æœªå¡«å¯«";
                document.getElementById('mem-ePhone').innerText = data.ePhone || "æœªå¡«å¯«";
                document.getElementById('manager-actions').style.display = 'none';
              } else {
                document.getElementById('emergency-info').style.display = 'none';
                document.getElementById('elder-info').style.display = 'block';
                document.getElementById('mem-uTitle').innerText = data.uTitle || "æœªå¡«å¯«";
                document.getElementById('mem-sAlias').innerText = data.sAlias || "æœªå¡«å¯«";
                
                // å¦‚æœå·²ç¶“æœ‰ç¶å®šå°è±¡
                if (data.hasManaged) {
                   // é¡¯ç¤ºæŒ‰éˆ•ä½†æ”¹æ–‡å­— (æˆ–ç¶­æŒé‚€è«‹åŠŸèƒ½ä»¥ä¾¿ç¶å®šç¬¬äºŒäºº)
                }
                document.getElementById('manager-actions').style.display = 'block';
              }
            }

            // C. é¡¯ç¤ºæ­·å²ç´€éŒ„
            const historyBox = document.getElementById('history-list');
            if (data.history && data.history.length > 0) {
              historyBox.innerHTML = data.history.map(item => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <span><i class="bi bi-check-circle-fill text-success"></i> ${item.name} å ±å¹³å®‰</span>
                  <span class="badge bg-light text-secondary border">${item.time}</span>
                </div>
              `).join('');
            } else {
              historyBox.innerHTML = '<div class="list-group-item small text-center text-muted py-3">ç›®å‰å°šç„¡ç´€éŒ„</div>';
            }

          } else {
            // === é¡¯ç¤ºè¨»å†Šé é¢ ===
            document.getElementById('register-page').style.display = 'block';
          }
        })
        .catch(err => showError("è®€å–è³‡æ–™å¤±æ•—: " + err.message));
    }

    function toggleFields() {
      const target = document.getElementById('reg-target').value;
      document.getElementById('fields-self').style.display = (target === 'self') ? 'block' : 'none';
      document.getElementById('fields-elder').style.display = (target === 'elder') ? 'block' : 'none';
    }

    // 3. è¨»å†Šè³‡æ–™é€å‡º (GET + SweetAlert2 + Regex)
    function submitRegister() {
      const name = document.getElementById('reg-name').value.trim();
      const phone = document.getElementById('reg-phone').value.trim();
      const target = document.getElementById('reg-target').value;
      
      // è¡¨å–®é©—è­‰
      if (!name) return Swal.fire({ icon: 'warning', title: 'è«‹è¼¸å…¥å§“å', text: 'æˆ‘å€‘éœ€è¦çŸ¥é“æ‚¨çš„çœŸå¯¦å§“å' });

      const phoneRegex = /^09\d{8}$/;
      if (!phoneRegex.test(phone)) {
        return Swal.fire({ icon: 'error', title: 'æ‰‹æ©Ÿæ ¼å¼éŒ¯èª¤', text: 'è«‹è¼¸å…¥ 09 é–‹é ­çš„ 10 ç¢¼æ•¸å­— (ä¸å« - )' });
      }

      // ç·Šæ€¥è¯çµ¡äººé©—è­‰
      if (target === 'self') {
        const eName = document.getElementById('reg-eName').value.trim();
        const ePhone = document.getElementById('reg-ePhone').value.trim();

        if (!eName) return Swal.fire({ icon: 'warning', title: 'æœªå¡«å¯«è¯çµ¡äºº', text: 'ç‚ºäº†æ‚¨çš„å®‰å…¨ï¼Œè«‹å¡«å¯«ç·Šæ€¥è¯çµ¡äºº' });
        if (!phoneRegex.test(ePhone)) {
          return Swal.fire({ icon: 'error', title: 'è¯çµ¡äººé›»è©±éŒ¯èª¤', text: 'è«‹è¼¸å…¥ 09 é–‹é ­çš„ 10 ç¢¼æ•¸å­—' });
        }
        if (phone === ePhone) {
          return Swal.fire({ icon: 'error', title: 'è³‡æ–™é‡è¤‡', text: 'ç·Šæ€¥è¯çµ¡äººä¸èƒ½å¡«å¯«æ‚¨è‡ªå·±çš„è™Ÿç¢¼ï¼' });
        }
      }

      // æº–å‚™åƒæ•¸
      let params = `action=register&uid=${userUid}&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}&target=${target}`;
      if (inviterId) params += `&inviter=${inviterId}`;

      if (target === 'self') {
        params += `&eName=${encodeURIComponent(document.getElementById('reg-eName').value)}&ePhone=${encodeURIComponent(document.getElementById('reg-ePhone').value)}`;
      } else {
        params += `&uTitle=${encodeURIComponent(document.getElementById('reg-uTitle').value)}&sAlias=${encodeURIComponent(document.getElementById('reg-sAlias').value)}`;
      }

      document.getElementById('loader').style.display = 'flex';
      
      // â˜… é—œéµä¿®æ­£ï¼šä½¿ç”¨ GET æ–¹æ³•é¿å… Load Failed â˜…
      fetch(`${gasUrl}?${params}`, { method: 'GET', mode: 'cors' }) 
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'è¨»å†ŠæˆåŠŸï¼',
              text: 'æ­¡è¿åŠ å…¥åšå®‰å®ˆè­·ä¸­å¿ƒ',
              confirmButtonText: 'é–‹å§‹ä½¿ç”¨',
              confirmButtonColor: '#667eea'
            }).then((result) => {
              if (result.isConfirmed) {
                location.href = window.location.pathname; // é‡æ•´é é¢é€²å…¥æœƒå“¡å¡
              }
            });
          } else {
            throw new Error(data.error || "æœªçŸ¥éŒ¯èª¤");
          }
        })
        .catch(err => showError("è¨»å†Šå¤±æ•—: " + err));
    }

    // 4. ç™¼é€é‚€è«‹ (å‹•æ…‹ç¨±è¬‚)
    function sendInvite() {
      if (!liff.isApiAvailable('shareTargetPicker')) return Swal.fire('åŠŸèƒ½ä¸æ”¯æ´', 'è«‹åœ¨ LINE App ä¸­é–‹å•Ÿæ­¤é é¢', 'warning');
      
      const senderName = document.getElementById('mem-name').innerText;
      let targetTitle = document.getElementById('mem-uTitle').innerText;
      
      // é˜²å‘†é è¨­å€¼
      if (!targetTitle || targetTitle === "---" || targetTitle === "æœªå¡«å¯«") {
        targetTitle = "å®¶äºº";
      }

      const inviteUrl = `https://liff.line.me/${liffId}?inviter=${userUid}`;

      liff.shareTargetPicker([{
        "type": "flex",
        "altText": `${senderName} é‚€è«‹æ‚¨åŠ å…¥åšå®‰å®ˆè­·`,
        "contents": {
          "type": "bubble",
          "styles": { "footer": { "separator": true } },
          "body": {
            "type": "box",
            "layout": "vertical",
            "contents": [
              { "type": "text", "text": "åšå®‰å®ˆè­·å¯¶", "weight": "bold", "color": "#4A90E2", "size": "md" },
              { "type": "text", "text": "æ‚¨èˆ‡å®¶äººå®‰å¿ƒçš„ä¾é ", "weight": "bold", "size": "xl", "margin": "md", "color": "#333333" },
              { "type": "text", "text": `è¦ªæ„›çš„ ${targetTitle}ï¼Œæˆ‘æ˜¯ ${senderName}ã€‚æˆ‘å·²ç”³è«‹ã€Œåšå®‰å®ˆè­·ã€ï¼Œé‚€è«‹æ‚¨æ¯å¤©æ‰“å¡å ±å¹³å®‰ã€‚`, "size": "md", "color": "#555555", "wrap": true, "margin": "lg" },
              { "type": "text", "text": "è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å®Œæˆç¶å®šï¼Œè®“æˆ‘å€‘æ¯å¤©æ—¥å¸¸å¤šä¸€ä»½å®‰å¿ƒã€‚", "size": "md", "color": "#555555", "wrap": true, "margin": "md" },
              {
                "type": "button",
                "style": "primary",
                "color": "#667eea",
                "margin": "xxl",
                "height": "sm",
                "action": { "type": "uri", "label": "âœ¨ æ¥å—å®ˆè­·ä¸¦ç¶å®š âœ¨", "uri": inviteUrl }
              }
            ]
          },
          "footer": {
            "type": "box",
            "layout": "vertical",
            "contents": [
              { "type": "text", "text": "æ­¤é€£çµåƒ…é™æœ¬äººç¶å®šä½¿ç”¨ï¼Œè«‹å‹¿è½‰å‚³", "size": "xxs", "color": "#aaaaaa", "align": "center" }
            ]
          }
        }
      }])
      .then(res => { 
        if (res) { 
           Swal.fire({ icon: 'success', title: 'é‚€è«‹å·²é€å‡º', text: 'è«‹ç­‰å¾…å°æ–¹é»æ“Šé€£çµç¶å®š', timer: 2000, showConfirmButton: false });
        } 
      })
      .catch(err => console.error("å‚³é€å¤±æ•—", err));
    }

    // 5. éŒ¯èª¤é¡¯ç¤ºå‡½å¼
    function showError(msg) {
      document.getElementById('loader').style.display = 'none';
      Swal.fire({
        icon: 'error',
        title: 'ç™¼ç”ŸéŒ¯èª¤',
        text: msg,
        confirmButtonColor: '#d33'
      });
    }

    // å•Ÿå‹•
    window.onload = init;
  </script>
</body>
</html>
