<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>厚安守護中心</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    .card { border-radius: 15px; border: none; }
    .bg-gradient-custom { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  </style>
</head>
<body class="bg-light">

  <div id="loader">
    <div class="spinner-border text-primary"></div>
    <p class="mt-3" id="loader-text">資料比對中...</p>
  </div>

  <div class="container p-4">
    <div id="register-page" style="display:none;">
  <div class="card shadow p-4">
    <h3 class="text-center mb-4">加入厚安守護中心</h3>
    
    <div class="mb-3">
      <label class="form-label">您的姓名</label>
      <input type="text" id="reg-name" class="form-control" placeholder="請輸入真實姓名">
    </div>
    <div class="mb-3">
      <label class="form-label">您的手機</label>
      <input type="tel" id="reg-phone" class="form-control" placeholder="09xxxxxxxx">
    </div>

    <div class="mb-3">
      <label class="form-label">您要守護的對象是？</label>
      <select id="reg-target" class="form-select" onchange="toggleFields()">
        <option value="self">自己</option>
        <option value="elder">親友</option>
      </select>
    </div>

    <div id="fields-self">
      <div class="mb-3">
        <label class="form-label">緊急聯絡人姓名</label>
        <input type="text" id="reg-eName" class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">緊急聯絡人電話</label>
        <input type="tel" id="reg-ePhone" class="form-control">
      </div>
    </div>

    <div id="fields-elder" style="display:none;">
      <div class="mb-3">
        <label class="form-label">您如何稱呼守護對象？(如：爺爺)</label>
        <input type="text" id="reg-uTitle" class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">該對象如何稱呼您？(如：乖孫小明)</label>
        <input type="text" id="reg-sAlias" class="form-control">
      </div>
    </div>

    <button onclick="submitRegister()" class="btn btn-primary w-100 py-2 mt-3">完成註冊</button>
  </div>
</div>

    <div id="member-page" style="display:none;">
  <div class="card shadow bg-gradient-custom p-4">
    <p class="small opacity-75 mb-2">MEMBER CARD</p>
    <h2 id="mem-name" class="mb-1">載入中...</h2>
    <p id="mem-phone" class="mb-3">---</p>
    
    <div id="emergency-info" style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px; display:none;">
      <p class="small mb-1" style="opacity: 0.8;">緊急聯絡資訊：</p>
      <p class="mb-0">姓名：<span id="mem-eName">---</span></p>
      <p class="mb-0">電話：<span id="mem-ePhone">---</span></p>
    </div>

    <div id="elder-info" style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px; display:none;">
      <p class="small mb-1" style="opacity: 0.8;">守護對象資訊：</p>
      <p class="mb-0">對象：<span id="mem-uTitle">---</span></p>
      <p class="mb-0">自稱：<span id="mem-sAlias">---</span></p>
    </div>

    <div class="text-end mt-3">
      <span class="badge bg-white text-dark">尊榮會員</span>
    </div>
  </div>
  
  <p class="text-center mt-3 small text-secondary">
    ※ 如需修改會員資料，請與客服聯繫。
  </p>
  
  <button class="btn btn-outline-secondary w-100 mt-2">查看歷史紀錄</button>
</div>

  <script>
  const liffId = "2008912295-edmRNdOM"; 
  const gasUrl = "https://script.google.com/macros/s/AKfycbzyedQifRTqM6bnusIsB5XHZfeCaQ22M5D1QoYh3cP92ugT5FrqRqj1EbI74qm4CTuq5w/exec"; 
  let userUid = "";

  // 1. 初始化 LIFF
  async function init() {
    try {
      await liff.init({ liffId: liffId });
      if (!liff.isLoggedIn()) { 
        liff.login(); 
        return;
      }
      const profile = await liff.getProfile();
      userUid = profile.userId;
      checkStatus(userUid);
    } catch (err) {
      showError("LIFF 初始化失敗: " + err);
    }
  }

  // 2. 檢查會員狀態 (查詢)
  function checkStatus(uid) {
      document.getElementById('loader').style.display = 'flex';
      document.getElementById('loader-text').innerText = "資料查詢中...";

      fetch(`${gasUrl}?action=query&uid=${uid}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('loader').style.display = 'none';
          document.getElementById('register-page').style.display = 'none';
          document.getElementById('member-page').style.display = 'none';

          if (data.exists) {
            // 顯示會員卡頁面
            document.getElementById('member-page').style.display = 'block';
            
            // 填入基本資料
            document.getElementById('mem-name').innerText = data.name;
            document.getElementById('mem-phone').innerText = "電話：" + data.phone;

            // --- 新增：判斷顯示欄位的邏輯 ---
            if (data.target === 'self') {
              // 顯示「自己」的緊急聯絡資訊，隱藏長輩資訊
              document.getElementById('emergency-info').style.display = 'block';
              document.getElementById('elder-info').style.display = 'none';
              
              document.getElementById('mem-eName').innerText = data.eName || "未填寫";
              document.getElementById('mem-ePhone').innerText = data.ePhone || "未填寫";
            } else {
              // 顯示「親友長輩」的資訊，隱藏緊急聯絡資訊
              document.getElementById('emergency-info').style.display = 'none';
              document.getElementById('elder-info').style.display = 'block';
              
              document.getElementById('mem-uTitle').innerText = data.uTitle || "未填寫";
              document.getElementById('mem-sAlias').innerText = data.sAlias || "未填寫";
            }
            // ---------------------------

          } else {
            // 若查無資料，顯示註冊頁面
            document.getElementById('register-page').style.display = 'block';
          }
        })
        .catch(err => showError("讀取資料失敗: " + err.message));
    }

  // 3. 【新功能】控制欄位顯示切換
  function toggleFields() {
    const target = document.getElementById('reg-target').value;
    // 根據選擇顯示對應區塊
    document.getElementById('fields-self').style.display = (target === 'self') ? 'block' : 'none';
    document.getElementById('fields-elder').style.display = (target === 'elder') ? 'block' : 'none';
  }

  // 4. 【新功能】處理註冊提交
  function submitRegister() {
    const name = document.getElementById('reg-name').value;
    const phone = document.getElementById('reg-phone').value;
    const target = document.getElementById('reg-target').value;
    
    if (!name || !phone) return alert("請完整填寫基本資料");

    // 基本參數
    let params = `action=register&uid=${userUid}&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}&target=${target}`;
    
    // 根據選擇加入額外參數
    if (target === 'self') {
      const eName = document.getElementById('reg-eName').value;
      const ePhone = document.getElementById('reg-ePhone').value;
      params += `&eName=${encodeURIComponent(eName)}&ePhone=${encodeURIComponent(ePhone)}`;
    } else {
      const uTitle = document.getElementById('reg-uTitle').value;
      const sAlias = document.getElementById('reg-sAlias').value;
      params += `&uTitle=${encodeURIComponent(uTitle)}&sAlias=${encodeURIComponent(sAlias)}`;
    }

    document.getElementById('loader').style.display = 'flex';
    document.getElementById('loader-text').innerText = "註冊資料寫入中...";

    fetch(`${gasUrl}?${params}`)
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("註冊成功！");
          checkStatus(userUid); // 註冊成功後自動切換至會員卡面
        } else {
          throw new Error("註冊過程發生錯誤");
        }
      })
      .catch(err => {
        document.getElementById('loader').style.display = 'none';
        alert("註冊失敗: " + err.message);
      });
  }

  function showError(msg) {
    document.getElementById('loader').style.display = 'none';
    alert(msg);
  }

  window.onload = init;
</script>
    
</body>
</html>
