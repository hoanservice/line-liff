<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>厚安守護中心</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    .card { border-radius: 15px; border: none; }
    .bg-gradient-custom { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
  </style>
</head>
<body class="bg-light">

  <div id="loader" class="text-center mt-5">
    <div class="spinner-border text-primary"></div>
    <p class="mt-3">資料比對中...</p>
  </div>

  <div class="container p-4">
    <div id="register-page" style="display:none;">
      <div class="card shadow p-4">
        <h3 class="text-center mb-4">加入守護中心</h3>
        <div class="mb-3">
          <label class="form-label">真實姓名</label>
          <input type="text" id="reg-name" class="form-control" placeholder="請輸入姓名">
        </div>
        <div class="mb-3">
          <label class="form-label">手機號碼</label>
          <input type="tel" id="reg-phone" class="form-control" placeholder="09xxxxxxxx">
        </div>
        <button onclick="submitRegister()" class="btn btn-primary w-100 py-2">完成註冊</button>
      </div>
    </div>

    <div id="member-page" style="display:none;">
      <div class="card shadow bg-gradient-custom p-4">
        <p class="small opacity-75">MEMBER CARD</p>
        <h2 id="mem-name" class="mb-3">載入中...</h2>
        <p class="mb-0">電話：<span id="mem-phone">---</span></p>
        <hr>
        <div class="text-end">
          <span class="badge bg-white text-dark">尊榮會員</span>
        </div>
      </div>
      <button class="btn btn-outline-secondary w-100 mt-4">查看歷史紀錄</button>
    </div>
  </div>

  <script>
    const liffId = "2008912295-edmRNdOM"; // 你的 LIFF ID
    const gasUrl = "https://script.google.com/macros/s/AKfycbzyedQifRTqM6bnusIsB5XHZfeCaQ22M5D1QoYh3cP92ugT5FrqRqj1EbI74qm4CTuq5w/exec"; 
    let userUid = "";

    async function init() {
      await liff.init({ liffId: liffId });
      if (!liff.isLoggedIn()) { liff.login(); }
      const profile = await liff.getProfile();
      userUid = profile.userId;
      checkStatus(userUid);
    }

    function checkStatus(uid) {
      // 設定一個 10 秒超時，防止網頁無限轉圈圈
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000);

      console.log("正在比對 UID:", uid);
      
      // 這裡會嘗試抓取資料
      fetch(`${gasUrl}?uid=${uid}`, { signal: controller.signal })
        .then(res => {
          clearTimeout(timeoutId);
          if (!res.ok) throw new Error('網路連線不穩或網址錯誤 (Status: ' + res.status + ')');
          return res.json();
        })
        .then(data => {
          console.log("收到回應:", data);
          document.getElementById('loader').style.display = 'none';
          
          if (data.isRegistered) {
            // 情境：已註冊，切換到會員頁面
            document.getElementById('member-page').style.display = 'block';
            document.getElementById('mem-name').innerText = data.name;
            document.getElementById('mem-phone').innerText = data.phone;
          } else {
            // 情境：未註冊，切換到註冊頁面
            document.getElementById('register-page').style.display = 'block';
          }
        })
        .catch(err => {
          clearTimeout(timeoutId);
          // --- 這裡就是除錯模式的重點：直接在手機畫面上顯示錯誤原因 ---
          document.getElementById('loader').innerHTML = `
            <div class="alert alert-danger mx-3">
              <strong>連線失敗</strong><br>
              原因：${err.name === 'AbortError' ? '連線逾時 (GAS沒回應)' : err.message}<br><br>
              <small>請檢查：<br>
              1. GAS 部署網址是否包含 /exec<br>
              2. 權限是否設為「所有人 (Anyone)」</small>
            </div>
            <button onclick="location.reload()" class="btn btn-outline-secondary btn-sm">重新整理</button>
          `;
          console.error("錯誤細節:", err);
        });
    }

    function submitRegister() {
      const name = document.getElementById('reg-name').value;
      const phone = document.getElementById('reg-phone').value;
      if (!name || !phone) return alert("請完整填寫");

      document.getElementById('loader').style.display = 'block';
      document.getElementById('register-page').style.display = 'none';

      fetch(`${gasUrl}?action=register&uid=${userUid}&name=${name}&phone=${phone}`)
        .then(() => {
          alert("註冊成功！");
          location.reload(); // 重新整理頁面，會自動跑 init 變成已註冊狀態
        });
    }

    window.onload = init;
  </script>
</body>
</html>
